#!/usr/bin/env bash
###################
## ES-Ubuntu     ##
##               ##
## Config        ##
## GNOME         ##
## Dash-to-panel ##
###################

# Dash-to-panel version
version=v42

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bootstrap.sh"
check-not-root || exit 1

# Options
profile="${1:?"Profile missing"}"
version=
# Read config file, get options
if file=$(cfg-get "${profile}" gnome/dash-to-panel); then
    configs=$(cfg-read "${file}")
    for line in ${configs}; do
        eval "${line}"
    done
fi
[[ -z "${version}" ]] && exit 1

print-header "Install Dash-to-panel..."
# Create temp dir
install_dir=$(mktemp -d)
# Get source
git clone "https://github.com/home-sweet-gnome/dash-to-panel.git" "${install_dir}"
git -C "${install_dir}" checkout "${version}"
# Install
make -C "${install_dir}" install
gnome-extensions enable dash-to-panel@jderose9.github.com
# Restart GNOME
busctl --user call org.gnome.Shell /org/gnome/Shell org.gnome.Shell Eval s "Meta.restart('Restarting...')"
print-finish

if file=$(cfg-get "${profile}" gnome/dash-to-panel.dconf); then
    print-status "Config Dash-to-panel.."
    sed -e '/^#/d' -e '/^$/d' "${file}" | dconf load /org/gnome/shell/extensions/
    print-finish
fi

exit 0
