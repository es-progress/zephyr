#!/usr/bin/env bash
################
## ES-Ubuntu  ##
##            ##
## Packages   ##
## Virtualbox ##
################

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

print-status "Load vboxdrv to kernel..."
sudo modprobe vboxdrv
print-finish

print-status "Apply global configs..."
configs=$(read-file-cfg "${ES_CUSTOMIZE_CFG}/apps/virtualbox")
for line in ${configs}; do
    IFS=$' \t' read -r cfg_name cfg_value <<< "${line}"
    if [[ -n "${cfg_name}" && -n "${cfg_value}" ]]; then
        # eval value to let the shell expand tilde and env vars
        cfg_value=$(eval echo "${cfg_value}")
        vboxmanage setproperty "${cfg_name}" "${cfg_value}"
    fi
done
print-finish

# Local settings
if [[ -f "${ES_CFG_LOCAL}/config/customize/apps/virtualbox/vboxconfig" ]]; then
    print-status "Apply local configs..."

    # vboxmanage configs
    vbox_configs=$(read-file-cfg "${ES_CFG_LOCAL}/config/customize/apps/virtualbox/vboxconfig" vboxmanage)
    for line in ${vbox_configs}; do
        IFS=$' \t' read -r cfg_name cfg_value <<< "${line}"
        if [[ -n "${cfg_name}" && -n "${cfg_value}" ]]; then
            # eval value to let the shell expand tilde and env vars
            cfg_value=$(eval echo "${cfg_value}")
            vboxmanage setproperty "${cfg_name}" "${cfg_value}"
        fi
    done

    # Other configs
    other_configs=$(read-file-cfg "${ES_CFG_LOCAL}/config/customize/apps/virtualbox/vboxconfig" settings)
    for line in ${other_configs}; do
        eval "${line}"
    done
    print-finish
fi

# Register VMs
if [[ -d "${ES_CFG_LOCAL}/config/customize/apps/virtualbox" ]]; then
    print-status "Register VMs..."

    # Get & create machine folder
    target_dir=$(echo "${VM_LOCAL_DIR:-~/.config/VirtualBox}")
    mkdir -p "${target_dir}"

    # Read VM info
    vm_info=$(read-file-cfg "${ES_CFG_LOCAL}/config/customize/apps/virtualbox/vboxconfig" virtmachines)
    for line in ${vm_info}; do
        eval "${line}"
    done

    registered_vms=$(vboxmanage list vms)

    for def in "${vm[@]:-}"; do
        IFS="@" read -r dir uuid <<<"${def}"

        # Check if already registered
        if ! grep -qs "${uuid}" <<<"${registered_vms}"; then
            cp -a "${ES_CFG_LOCAL}/config/customize/apps/virtualbox/${dir}" "${target_dir}"
            find "$target_dir/${dir}" -name "*.vbox" -exec vboxmanage registervm '{}' \;
        fi
    done
    print-finish
fi

exit 0
