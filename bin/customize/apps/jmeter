#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Config    ##
## JMeter    ##
###############

# Strict mode
set -eufo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bootstrap.sh"
check-not-root || exit 1

# Options
profile="${1:?"Profile missing"}"
version=
url=
checksum=
install_dir=

# Read config file, get options
if file=$(cfg-get "${profile}" apps/global.cfg); then
    cfg-eval "${file}" jmeter
fi
if file=$(cfg-get "${profile}" apps/local.cfg); then
    cfg-eval "${file}" jmeter
fi

[[ -z "${version}" ]] && exit 1
[[ -z "${url}" ]] && exit 1
[[ -z "${checksum}" ]] && exit 1
[[ -z "${install_dir}" ]] && exit 1

print-header "Install jmeter..."
# Download tar
tmp_file=$(mktemp)
tmp_dir=$(mktemp -d)
curl --progress-bar -o "${tmp_file}" --url "${url}"
hash=$(sha512sum "${tmp_file}" | cut -d" " -f1)
[[ "${hash}" != "${checksum}" ]] && error-exit "Bad checksum, exiting"
# Unpack archive
tar -C "${tmp_dir}" -xf "${tmp_file}"
sudo rm -rf "${install_dir}"
sudo cp -r "${tmp_dir}/apache-jmeter-${version}" "${install_dir}"
rm -rf "${tmp_file}" "${tmp_dir}"
print-finish

exit 0
