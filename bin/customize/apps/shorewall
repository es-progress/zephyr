#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Config    ##
## shorewall ##
###############

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

# Get all interfaces
interfaces=$(ls -1 /sys/class/net --hide lo)

print-status "Copy global shorewall config..."
files=$(find "${ES_CUSTOMIZE_CFG}/shorewall" -type f)
for file in ${files}; do
    sudo cp "${file}" /etc/shorewall/
done

for iface in ${interfaces}; do
    # Duplicate template line
    sudo sed -i "/{{ interface }}/p" /etc/shorewall/interfaces
    # Insert actual interface to first occurance
    sudo sed -i "0,/{{ interface }}/ s/{{ interface }}/${iface}/" /etc/shorewall/interfaces
done
# Delete untemplated lines
sudo sed -i "/{{ interface }}/d" /etc/shorewall/interfaces
print-finish

if [[ -d "${ES_CFG_LOCAL}/config/customize/shorewall" ]]; then
    print-status "Copy local shorewall config..."
    files=$(find "${ES_CFG_LOCAL}/config/customize/shorewall" -type f)
    for file in ${files}; do
        sudo cp "${file}" /etc/shorewall/
    done
    print-finish
fi

print-header "Start shorewall..."
sudo systemctl enable shorewall.service
sudo systemctl start shorewall.service
sudo systemctl reload shorewall.service
sudo shorewall save
print-finish

exit 0
