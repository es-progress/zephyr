#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Config    ##
## Shorewall ##
###############

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bootstrap.sh"
check-not-root || exit 1

profile="${1:?"Profile missing"}"

if dir=$(cfg-get default apps/shorewall/global); then
    print-status "Copy global shorewall config..."
    files=$(find "${dir}" -mindepth 1 -maxdepth 1)
    for file in ${files}; do
        sudo cp -r "${file}" /etc/shorewall/
    done
    print-finish
fi

if dir=$(cfg-get "${profile}" apps/shorewall/local); then
    print-status "Copy local shorewall config..."
    files=$(find "${dir}" -mindepth 1 -maxdepth 1)
    for file in ${files}; do
        sudo cp -r "${file}" /etc/shorewall/
    done
    print-finish
fi

print-status "Template interfaces..."
interfaces=$(ls -1 /sys/class/net --hide lo)
for iface in ${interfaces}; do
    # Duplicate template line
    sudo sed -i "/{{ interface }}/p" /etc/shorewall/interfaces
    # Insert actual interface to first occurance
    sudo sed -i "0,/{{ interface }}/ s/{{ interface }}/${iface}/" /etc/shorewall/interfaces
done
# Delete untemplated lines
sudo sed -i "/{{ interface }}/d" /etc/shorewall/interfaces
print-finish

print-header "Start shorewall..."
sudo systemctl enable shorewall.service
sudo systemctl start shorewall.service
sudo systemctl reload shorewall.service
sudo shorewall save
print-finish

exit 0
