#!/usr/bin/env bash
####################
## Zephyr         ##
##                ##
## Runner         ##
## Customizations ##
####################

# Dirs to run (Name;Path)
exec_dir=(
    "Setup system;system"
    "Install packages;packages"
    "Install services;services"
    "Setup shell;shell"
    "Config tools;tools"
    "Config apps;apps"
    "Config GNOME;gnome"
    "Random configs;random"
)

# Strict mode
set -eufo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bin/bootstrap.sh"

# Parse options
profile="${1?:"Profile missing"}"
shift
# shellcheck disable=SC2311
modules=$(implode "|" "${@}")
filter=()
[[ -n "${modules}" ]] && filter=("--regex=^(${modules})\$")

for item in "${exec_dir[@]}"; do
    IFS=";" read -r name dir <<<"${item}"
    runnable=$(run-parts --test "${filter[@]}" "${PATH_SCRIPTS_CUSTOMIZE}/${dir}")
    if [[ -n "${runnable}" ]]; then
        print-section "${name}"
        run-parts --exit-on-error "${filter[@]}" --arg="${profile}" "${PATH_SCRIPTS_CUSTOMIZE}/${dir}"
    fi
done

exit 0
