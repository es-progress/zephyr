#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Config    ##
## MariaDB   ##
###############

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bootstrap.sh"
check-not-root || exit 1

# Options
profile="${1:?"Profile missing"}"
repo=

# Read config file, get options
if file=$(cfg-get "${profile}" services/mariadb/config); then
    configs=$(cfg-read "${file}")
    for line in ${configs}; do
        eval "${line}"
    done
fi
[[ -z "${repo}" ]] && exit 1

print-header "Add MariaDB GPG key..."
sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8
print-finish

print-header "Add MariaDB repo..."
sudo add-apt-repository --yes "${repo}"
print-finish

print-header "Install MariaDB..."
sudo apt-get install --yes --no-install-recommends mariadb-server mariadb-backup python3-pymysql
print-finish

if file=$(cfg-get "${profile}" services/mariadb/mariadb.cnf); then
    print-status "Config MariaDB..."
    sudo cp "${file}" /etc/mysql/conf.d/esubuntu.cnf
    print-finish
fi

print-header "Restart services..."
sudo systemctl enable mariadb.service
sudo systemctl restart mariadb.service
print-finish

print-status "Create DB admin..."
sudo mysql -e "CREATE USER IF NOT EXISTS '${MARIADB_ADMIN_NAME}'@'localhost' IDENTIFIED BY '${MARIADB_ADMIN_PASS}';"
sudo mysql -e "GRANT ALL ON *.* TO '${MARIADB_ADMIN_NAME}'@localhost WITH GRANT OPTION;"
sudo mysql -e "FLUSH PRIVILEGES;"
print-finish

exit 0
