#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Services  ##
## PHP       ##
###############

# PHP version
version="7.4"

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

print-header "Add PHP repo..."
sudo add-apt-repository --yes ppa:ondrej/php
print-finish

print-header "Install PHP & extensions..."
php_extensions=$(read-file-cfg "${ES_CUSTOMIZE_CFG}/services/php/extensions")
packages=()
packages+=("php${version}")
while read -r extension; do
    packages+=("php${version}-${extension}")
done <<< "${php_extensions}"
sudo apt install --yes "${packages[@]}"
print-finish

print-status "Config PHP..."
sudo cp "${ES_CUSTOMIZE_CFG}/services/php/fpm.php.ini" "/etc/php/${version}/fpm/php.ini"
sudo cp "${ES_CUSTOMIZE_CFG}/services/php/cli.php.ini" "/etc/php/${version}/cli/php.ini"
sudo cp "${ES_CUSTOMIZE_CFG}/services/php/xdebug.ini" "/etc/php/${version}/mods-available/xdebug.ini"
print-finish

print-header "Restarting services..."
sudo systemctl enable "php${version}-fpm.service"
sudo systemctl restart "php${version}-fpm.service"
sudo a2enconf "php${version}-fpm"
sudo systemctl restart apache2.service
print-finish

exit 0
