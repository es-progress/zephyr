#!/usr/bin/env bash
################
## ES-Ubuntu  ##
##            ##
## Services   ##
## PHPMyAdmin ##
################

# PHPMyAdmin
version="5.1.1"
url="https://files.phpmyadmin.net/phpMyAdmin/5.1.1/phpMyAdmin-5.1.1-all-languages.tar.gz"
checksum="8264b57aeaa1f91c6d859331777c71e80d26088bef7cdcd5f9431119747ed1c1"

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

print-header "Install PHPMyAdmin..."
# Download tar
tmp_file=$(mktemp)
curl --progress-bar -o "${tmp_file}" --url "${url}"
hash=$(sha256sum "${tmp_file}" | cut -d" " -f1)
[[ "${hash}" != "${checksum}" ]] && error-exit "Bad checksum, exiting"
# Unpack archive
target="${WEB_ROOT}/phpmyadmin"
sudo rm -rf "${target}"
sudo mkdir -p "${target}"
sudo tar -C "${target}" -xf "${tmp_file}"
sudo mv "${target}/phpMyAdmin-${version}-all-languages" "${target}/public"
print-finish

print-status "Configure PHPMyAdmin..."
secret=$(openssl rand -hex 32)
sudo cp "${ES_CUSTOMIZE_CFG}/services/phpmyadmin/config.inc.php" "${target}/public"
sudo sed -i "s/{{ pma_user_name }}/${PHPMYADMIN_CONTROL_NAME}/g" "${target}/public/config.inc.php"
sudo sed -i "s/{{ pma_user_pass }}/${PHPMYADMIN_CONTROL_PASS}/g" "${target}/public/config.inc.php"
sudo sed -i "s/{{ blowfish_secret }}/${secret}/g" "${target}/public/config.inc.php"
sudo sed -i "s@{{ destination }}@${WEB_ROOT}/phpmyadmin@g" "${target}/public/config.inc.php"
print-finish

print-status "Create tmp dirs, set permissions..."
sudo mkdir -p "${target}/upload" "${target}/save" "${target}/tmp"
sudo chgrp -R www-data "${target}"
sudo chmod g+w "${target}/upload" "${target}/save" "${target}/tmp"
print-finish

print-status "Create PHPMyAdmin control DB..."
[[ -f "${target}/public/sql/create_tables.sql" ]] || error-exit "Import SQL file missing"
sudo mysql <"${target}/public/sql/create_tables.sql"
print-finish

print-status "Create PHPMyAdmin control user..."
sudo mysql -e "CREATE USER IF NOT EXISTS '${PHPMYADMIN_CONTROL_NAME}'@'localhost' IDENTIFIED BY '${PHPMYADMIN_CONTROL_PASS}';"
sudo mysql -e "GRANT SELECT, INSERT, DELETE, UPDATE, ALTER ON phpmyadmin.* TO '${PHPMYADMIN_CONTROL_NAME}'@localhost;"
sudo mysql -e "FLUSH PRIVILEGES;"
print-finish

exit 0
