#!/usr/bin/env bash
############
## Zephyr ##
##        ##
## Config ##
## fstab  ##
############

# Strict mode
set -eufo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bin/bootstrap.sh"
check-not-root

print-status "Create fstab new version..."
tmp_file=$(mktemp)
awk '
{
    # Print comments and empty lines as is
    if ($0 ~ "^#" || $0 ~ "^$") {
        print
    } else {
        if ($3 != "swap") {
            if ($4 !~ ".*noatime.*") {
                $4=$4",noatime"
            }
        }
        print $1,$2,$3,$4,$5,$6
    }
}
' /etc/fstab > "${tmp_file}"
print-finish

print-header "Verify fstab..."
if findmnt --verify --tab-file "${tmp_file}"; then
    verified=1
    print-finish
else
    verified=
    print-error Fail
fi

if [[ -n "${verified}" ]]; then
    print-status "Update fstab to new version..."
    sudo cp --no-preserve=mode,ownership "${tmp_file}" /etc/fstab
    print-finish
else
    print-status "Verify failed, skip updating fstab\n"
fi

exit 0
