#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Config    ##
## SSH       ##
###############

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

print-status "Copy SSH config files..."
mkdir -p ~/.ssh
cp -a "${ES_CUSTOMIZE_CFG}"/ssh/* ~/.ssh/
print-finish

if [[ -d "${ES_CFG_LOCAL}/config/customize/ssh/hosts" ]]; then
    print-status "Copy SSH hosts config..."
    mkdir -p ~/.ssh/hosts
    for file in "${ES_CFG_LOCAL}"/config/customize/ssh/hosts/*; do
        cp -a "${file}" ~/.ssh/hosts/
    done
    print-finish
fi

if [[ -f "${ES_CFG_LOCAL}/config/customize/ssh/host_ca" ]]; then
    print-status "Setup trusted cert-authorities..."
    touch ~/.ssh/known_hosts
    host_ca=$(read-file-cfg "${ES_CFG_LOCAL}/config/customize/ssh/host_ca")
    while read -r line; do
        if ! grep -F -qs "@cert-authority ${line}" ~/.ssh/known_hosts; then
            echo "@cert-authority ${line}" >> ~/.ssh/known_hosts
        fi
    done <<< "${host_ca}"
    print-finish
fi

exit 0
