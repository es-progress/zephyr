#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Config    ##
## Scripts   ##
###############

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bootstrap.sh"
check-not-root || exit 1

profile="${1:?"Profile missing"}"

if dir=$(cfg-get "${profile}" shell/bin/global.d); then
    print-status "Copy shell scripts [global]..."
    sudo mkdir -p "${GLOBAL_BIN}"
    find -L "${dir}" -mindepth 1 -maxdepth 1 -type f -exec sudo cp --no-preserve=mode,ownership {} "${GLOBAL_BIN}/" \;
    find -L "${dir}" -mindepth 1 -maxdepth 1 -type f -printf "%f\0" | xargs -0I {} sudo chmod +x "${GLOBAL_BIN}/{}"
    print-finish
fi
if dir=$(cfg-get "${profile}" shell/bin/local.d); then
    print-status "Copy shell scripts [local]..."
    mkdir -p "${LOCAL_BIN}"
    find -L "${dir}" -mindepth 1 -maxdepth 1 -type f -exec cp -r --no-preserve=mode,ownership {} "${LOCAL_BIN}/" \;
    find -L "${dir}" -mindepth 1 -maxdepth 1 -type f -printf "%f\0" | xargs -0I {} chmod +x "${LOCAL_BIN}/{}"
    print-finish
fi
if dir=$(cfg-get "${profile}" shell/lib/global.d); then
    print-status "Copy shell library [global]..."
    sudo mkdir -p "${GLOBAL_LIB}"
    find -L "${dir}" -type f -exec sudo cp --no-preserve=mode,ownership {} "${GLOBAL_LIB}/" \;
    print-finish
fi
if dir=$(cfg-get "${profile}" shell/lib/local.d); then
    print-status "Copy shell library [local]..."
    sudo mkdir -p "${LOCAL_LIB}"
    find -L "${dir}" -type f -exec cp --no-preserve=mode,ownership {} "${LOCAL_LIB}/" \;
    print-finish
fi

print-status "Link esubuntuctl..."
[[ -e "${LOCAL_BIN}/esubuntuctl" ]] || ln -s "${PROJECT_ROOT}/esubuntuctl" "${LOCAL_BIN}/esubuntuctl"
print-finish

exit 0
