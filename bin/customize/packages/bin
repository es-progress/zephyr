#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Packages  ##
## Shell bin ##
###############

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

print-header "Install vendor shell programs..."
sudo mkdir -p "${GLOBAL_BIN}"
binaries=$(read-file-cfg "${ES_CUSTOMIZE_CFG}/packages/bin")
for line in ${binaries}; do
    IFS=$' \t' read -r name url checksum <<< "${line}"

    print-header "Install ${name}..."

    # Check if already installed
    if [[ -e "${GLOBAL_BIN}/${name}" ]]; then
        hash=$(sha256sum "${GLOBAL_BIN}/${name}" | cut -d" " -f1)
        if [[ "${hash}" == "${checksum}" ]]; then
            print-finish "Already installed, skipped."
            continue
        fi
    fi

    tmp_file=$(mktemp)
    curl --progress-bar --location -o "${tmp_file}" --url "${url}"

    if [[ -n "${checksum}" ]]; then
        hash=$(sha256sum "${tmp_file}" | cut -d" " -f1)
        if [[ "${hash}" != "${checksum}" ]]; then
            print-error "Bad checksum for ${name}, skipping."
            continue
        fi
    fi

    sudo mv "${tmp_file}" "${GLOBAL_BIN}/${name}"
    sudo chown root:root "${GLOBAL_BIN}/${name}"
    sudo chmod =0755 "${GLOBAL_BIN}/${name}"
    print-finish
done
print-finish

exit 0
