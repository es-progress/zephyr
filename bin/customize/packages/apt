#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Packages  ##
## apt       ##
###############

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bootstrap.sh"
check-not-root || exit 1

profile="${1:?"Profile missing"}"

if file=$(cfg-get "${profile}" packages/apt.install); then
    # Parse packages to install
    repos=()
    packages=()
    apt_packages=$(cfg-read "${file}")
    for line in ${apt_packages}; do
        IFS=$' \t' read -r package repo <<< "${line}"
        [[ -n "${repo}" ]] && repos+=("${repo}")
        packages+=("${package}")
    done

    for repo in "${repos[@]}"; do
        print-header "Add apt repo: ${repo}..."
        sudo add-apt-repository --yes --no-update "${repo}"
        print-finish
    done

    print-header "Update apt cache..."
    sudo apt-get update
    print-finish

    print-header "Install packages..."
    sudo apt-get install --yes --no-install-recommends "${packages[@]}"
    print-finish
fi

if file=$(cfg-get "${profile}" packages/apt.delete); then
    # Parse packages to delete
    packages=()
    apt_packages=$(cfg-read "${file}")
    for package in ${apt_packages}; do
        packages+=("${package}")
    done

    print-header "Remove packages..."
    sudo apt-get remove --yes --purge --autoremove "${packages[@]}"
    print-finish
fi

print-header "Upgrade packages..."
sudo apt-get upgrade --yes
print-finish

print-header "Run apt clean..."
sudo apt-get clean
print-finish

exit 0
