#!/usr/bin/env bash
###############
## ES-Ubuntu ##
##           ##
## Packages  ##
## apt       ##
###############

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

# Read packages to install
repos=()
packages=()
apt_packages=$(read-file-cfg "${ES_CUSTOMIZE_CFG}/packages/apt")
for line in ${apt_packages}; do
    IFS=$' \t' read -r package repo <<< "${line}"
    [[ -n "${repo}" ]] && repos+=("${repo}")
    packages+=("${package}")
done

for repo in "${repos[@]}"; do
    print-header "Add apt repo: ${repo}..."
    sudo add-apt-repository --yes --no-update "${repo}"
    print-finish
done

print-header "Update apt cache..."
sudo apt-get update
print-finish

print-header "Install packages..."
sudo apt-get install --yes --no-install-recommends "${packages[@]}"
print-finish

# Read packages to delete
packages=()
apt_packages=$(read-file-cfg "${ES_CUSTOMIZE_CFG}/packages/apt-delete")
for package in ${apt_packages}; do
    packages+=("${package}")
done

print-header "Remove packages..."
sudo apt-get remove --yes --purge --autoremove "${packages[@]}"
print-finish

print-header "Upgrade packages..."
sudo apt-get upgrade --yes
print-finish

print-header "Run apt clean..."
sudo apt-get clean
print-finish

exit 0
