#!/usr/bin/env bash
############
## Zephyr ##
##        ##
## Config ##
## apt    ##
############

###############
## FUNCTIONS ##
###############

## Parse install packages
##
## @param   $1  Global/Local
## @param   $2  Config file
############################
_parse-install-packages() {
    local selector="${1:?"Selector missing"}"
    local cfg_file="${2:?"Config file missing"}"

    print-status "Parse packages to install [${selector}]..."
    # shellcheck disable=SC2310,SC2311
    for line in $(cfg-read "${cfg_file}" apt-install); do
        IFS=$' \t' read -r package repo <<< "${line}"
        [[ -n "${repo}" ]] && repos+=("${repo}")
        packages_install+=("${package}")
    done
    print-finish
}

## Parse remove packages
##
## @param   $1  Global/Local
## @param   $2  Config file
############################
_parse-remove-packages() {
    local selector="${1:?"Selector missing"}"
    local cfg_file="${2:?"Config file missing"}"

    print-status "Parse packages to remove [${selector}]..."
    # shellcheck disable=SC2310,SC2311
    for package in $(cfg-read "${cfg_file}" apt-remove); do
        packages_remove+=("${package}")
    done
    print-finish
}

##################
## SCRIPT START ##
##################

# Strict mode
set -eufo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bin/bootstrap.sh"
check-not-root

profile="${1:?"Profile missing"}"

# Parse packages
repos=()
packages_install=()
packages_remove=()
# shellcheck disable=SC2310,SC2311
if file=$(cfg-get "${profile}" packages/global.cfg); then
    _parse-install-packages global "${file}"
    _parse-remove-packages global "${file}"
fi
# shellcheck disable=SC2310,SC2311
if file=$(cfg-get "${profile}" packages/local.cfg); then
    _parse-install-packages local "${file}"
    _parse-remove-packages local "${file}"
fi

for repo in "${repos[@]}"; do
    print-header "Add apt repo: ${repo}..."
    sudo add-apt-repository --yes --no-update "${repo}"
    print-finish
done

print-header "Update apt cache..."
sudo apt-get update
print-finish

print-header "Install packages..."
sudo apt-get install --yes --no-install-recommends "${packages_install[@]}"
print-finish

print-header "Remove packages..."
sudo apt-get remove --yes --purge --autoremove "${packages_remove[@]}"
print-finish

print-header "Upgrade packages..."
sudo apt-get upgrade --yes
print-finish

print-header "Run apt clean..."
sudo apt-get clean
print-finish

exit 0
