#!/usr/bin/env bash
##################
## ES-Ubuntu    ##
##              ##
## Config       ##
## Certificates ##
##################

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

# Machine Owner Key (MOK)
#########################
print-header "Install mokutil..."
sudo apt install --yes mokutil
print-finish

key_created=""
print-status "Create MOK private key..."
if sudo test ! -e "/etc/ssl/private/${MOK_KEY_NAME}.key"; then
    sudo openssl \
        genpkey \
        -algorithm rsa \
        -pkeyopt rsa_keygen_bits:4096 \
        -out "/etc/ssl/private/${MOK_KEY_NAME}.key"
    key_created="1"
    print-finish
else
    print-finish "Key found, skipped"
fi

print-header "Create MOK certificate..."
if [[ ! -e "/etc/ssl/certs/${MOK_KEY_NAME}.der" || -n "${key_created}" ]]; then
    sudo openssl \
        req \
        -new \
        -x509 \
        -sha256 \
        -key "/etc/ssl/private/${MOK_KEY_NAME}.key" \
        -outform DER \
        -out "/etc/ssl/certs/${MOK_KEY_NAME}.der" \
        -days 3650 \
        -subj "${MOK_KEY_SUBJECT}"
    print-finish
else
    print-finish "Certificate found, skipped"
fi

print-header "Enrolling MOK certificate..."
cert_fingerprint=$(openssl x509 -noout -sha1 -fingerprint -inform DER -in "/etc/ssl/certs/${MOK_KEY_NAME}.der" | cut -d= -f2)
if ! mokutil --list-enrolled | grep -qs "SHA1 Fingerprint: ${cert_fingerprint}"; then
    sudo mokutil --import "/etc/ssl/certs/${MOK_KEY_NAME}.der"
    print-finish
else
    print-finish "Already enrolled, skipped"
fi

# Self-signed root CA certificate
#################################
key_created=""
cert_created=""
print-status "Create ROOT CA private key..."
if sudo test ! -e "/etc/ssl/private/${ROOT_CA_NAME}.key"; then
    sudo openssl \
        genpkey \
        -algorithm rsa \
        -pkeyopt rsa_keygen_bits:4096 \
        -out "/etc/ssl/private/${ROOT_CA_NAME}.key"
    key_created="1"
    print-finish
else
    print-finish "Key found, skipped"
fi

print-status "Create self-signed ROOT CA certificate..."
if [[ ! -e "/usr/local/share/ca-certificates/${ROOT_CA_NAME}.crt" || -n "${key_created}" ]]; then
    sudo openssl \
        req \
        -new \
        -x509 \
        -sha512 \
        -extensions v3_ca \
        -addext "keyUsage=critical,keyCertSign,cRLSign" \
        -key "/etc/ssl/private/${ROOT_CA_NAME}.key" \
        -out "/usr/local/share/ca-certificates/${ROOT_CA_NAME}.crt" \
        -days 3650 \
        -subj "${ROOT_CA_SUBJECT}"
    cert_created="1"
    print-finish
else
    print-finish "Certificate found, skipped"
fi

# Update ca-cert
if [[ -n "${cert_created}" ]]; then
    print-header "Install root CA certificate to system..."
    sudo update-ca-certificates
    print-finish

    print-status "Install root CA certificate to Firefox..."
    sudo mkdir -p /usr/lib/firefox/distribution
    sudo cp "${ES_CUSTOMIZE_CFG}/random/firefox-policies.json" /usr/lib/firefox/distribution/policies.json
    sudo chmod =0644 /usr/lib/firefox/distribution/policies.json
    print-finish
fi

exit 0
