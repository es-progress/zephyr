#!/usr/bin/env bash
################
## Zephyr     ##
##            ##
## Controller ##
#################

###############
## FUNCTIONS ##
###############

## Main usage text
##################
_usage-main() {
    local command=()
    local sorted_commands_array=()
    local line name help sorted_commands_string

    command+=("remix:Create Zephyr ISO")
    command+=("burn:Burn Zephyr ISO to USB")
    command+=("partition:Partition disk")
    command+=("post-install:OS post-install steps")
    command+=("customize:Customize Ubuntu")
    command+=("install:Install Zephyr")
    command+=("uninstall:Uninstall Zephyr")
    command+=("help:Display help")
    sorted_commands_string=$(sort <<<"${command[*]}")
    mapfile -t sorted_commands_array <<<"${sorted_commands_string[*]}"

    echo -e "${TXT_GREEN}Zephyr${TXT_NORM} controller"
    echo -e "Copyright (C) 2023 Sandor Semsey\n"
    echo -e "${TXT_YELLOW}Usage:${TXT_NORM}"
    echo -e  "  zephyrctl COMMAND [OPTIONS]...\n"
    echo -e  "${TXT_YELLOW}Commands:${TXT_NORM}"
    for line in "${sorted_commands_array[@]}"; do
        IFS=":" read -r name help <<<"${line}"
        printf "  ${TXT_GREEN}%-20s${TXT_NORM}%s\n" "${name}" "${help}"
    done

    exit 1
}

## Print usage
##
## @param    $1  Usage selector
###############################
_usage() {
    local selector="${1:-}"
    local usage line name help
    local options=()

    case "${selector}" in
        "")
            description="Display help for a command"
            usage="help COMMAND"
            options+=("COMMAND:The command name (to view available commands, run 'zephyrctl' without arguments)")
            ;;
        remix)
            description="Remix an Ubuntu image file and embed Zephyr (along with your profiles)"
            usage="remix ISO_IN [ISO_OUT]"
            options+=("ISO_IN:ISO to remix (e.g. Ubuntu Live DVD)")
            options+=("ISO_OUT:Remixed ISO file. Defaults to zephyr.iso in current dir.")
            ;;
        burn)
            description="Create a bootable USB stick from an image file"
            usage="burn ISO_FILE [DISK]"
            options+=("ISO_FILE:ISO to burn (e.g. remixed Ubuntu Live DVD)")
            options+=("DISK:USB flash drive device file (e.g. /dev/sdc). If not specified, you can select one interactively.")
            ;;
        partition)
            description="Partition a drive. Be careful, as it's a dangerous operation. Create backups beforehand!"
            usage="partition PROFILE MAP..."
            options+=("PROFILE:Customization profile to use")
            options+=("MAP:Partition maps")
            ;;
        post-install)
            description="Perform various OS post-install steps (e.g. GRUB configuration, backup GPT)"
            usage="post-install PROFILE MAP..."
            options+=("PROFILE:Customization profile to use")
            options+=("MAP:Partition maps")
            ;;
        customize)
            description="Update/customize a module. This command plays a key role in customizing your Ubuntu installation."
            usage="customize PROFILE [MODULE]..."
            options+=("PROFILE:Customization profile to use")
            options+=("MODULE:Module to update (eg. packages, bash). If none given, all modules will be customized.")
            ;;
        install)
            description="Install Zephyr on your computer"
            usage="install"
            ;;
        uninstall)
            description="Remove Zephyr from your computer"
            usage="uninstall"
            ;;
        *) _usage-main ;;
    esac

    echo -e "${TXT_YELLOW}Description:${TXT_NORM}"
    echo -e "  ${description}\n"
    echo -e "${TXT_YELLOW}Usage:${TXT_NORM}"
    echo -e "  zephyrctl ${usage}\n"
    if [[ -n "${options[*]}" ]]; then
        echo -e "${TXT_YELLOW}Options:${TXT_NORM}"
        for line in "${options[@]}"; do
            IFS=":" read -r name help <<<"${line}"
            printf "  ${TXT_GREEN}%-20s${TXT_NORM}%s\n" "${name}" "${help}"
        done
    fi
}

## Create ISO
#############
# shellcheck disable=SC2317
_remix() {
    if [[ -z "${1:-}" ]]; then
        print-error "ISO image missing!"
        _usage remix
        exit 1
    fi
    "${PATH_SCRIPTS_REMIX}/unpack" "${1}"
    "${PATH_SCRIPTS_REMIX}/copy-files"
    "${PATH_SCRIPTS_REMIX}/pack" "${1}" "${2:-}"
    "${PATH_SCRIPTS_REMIX}/clean-up"
}

## Burn ISO
###########
# shellcheck disable=SC2317
_burn() {
    if [[ -z "${1:-}" ]]; then
        print-error "ISO image missing!"
        _usage burn
        exit 1
    fi
    "${PATH_SCRIPTS_REMIX}/burn" "${1}" "${2:-}"
}

## Install Zephyr
#################
# shellcheck disable=SC2317
_install() {
    print-status "Set up Bash completion..."
    sudo cp --no-preserve=mode,ownership "${PROJECT_ROOT}/bin/completion.sh" /etc/bash_completion.d/zephyrctl
    sudo sed -i "s@{{ INSTALL_DIR }}@${PROJECT_ROOT}@g" /etc/bash_completion.d/zephyrctl
    print-finish

    print-status "Symlink controller..."
    sudo rm -f /usr/local/bin/zephyrctl
    sudo ln -s "${PROJECT_ROOT}/bin/zephyrctl" /usr/local/bin/zephyrctl
    print-finish
}

## Uninstall Zephyr
#################
# shellcheck disable=SC2317
_uninstall() {
    print-status "Remove Bash completion..."
    sudo rm /etc/bash_completion.d/zephyrctl
    print-finish

    print-status "Unlink controller..."
    sudo rm -f /usr/local/bin/zephyrctl
    print-finish

    print-status "Remove Zephyr files..."
    sudo rm -rf "${INSTALL_DIR}"
    print-finish
}

## Partition disks
##################
# shellcheck disable=SC2317
_partition() {
    local profile

    if [[ -z "${1:-}" ]]; then
        print-error "Profile missing!"
        _usage partition
        exit 1
    fi
    profile="${1}"
    if [[ ! -e "${PATH_PROFILES}/${profile}" ]]; then
        print-error "Profile: ${profile} missing!"
        exit 1
    fi
    shift

    sudo env PROJECT_ROOT="${PROJECT_ROOT}" "${PATH_SCRIPTS_INSTALL}/partition" "${profile}" "${@}"
}

## Post-install
###############
# shellcheck disable=SC2317
_post-install() {
    local profile

    if [[ -z "${1:-}" ]]; then
        print-error "Profile missing!"
        _usage post-install
        exit 1
    fi
    profile="${1}"
    if [[ ! -e "${PATH_PROFILES}/${profile}" ]]; then
        print-error "Profile: ${profile} missing!"
        exit 1
    fi
    shift

    sudo env PROJECT_ROOT="${PROJECT_ROOT}" "${PATH_SCRIPTS_INSTALL}/post-install" "${profile}" "${@}"
}

## Customize
##
## @param   $1  Profile
#######################
# shellcheck disable=SC2317
_customize() {
    local profile
    local module_selected=

    if [[ -z "${1:-}" ]]; then
        print-error "Profile missing!"
        _usage customize
        exit 1
    fi
    profile="${1}"
    if [[ ! -e "${PATH_PROFILES}/${profile}" ]]; then
        print-error "Profile: ${profile} missing!"
        exit 1
    fi
    shift

    [[ $# -gt 0 ]] && module_selected=1

    [[ -z "${module_selected}" ]] && sudo systemctl stop unattended-upgrades.service
    "${PATH_SCRIPTS_CUSTOMIZE}/runner" "${profile}" "${@}"
    [[ -z "${module_selected}" ]] && sudo systemctl start unattended-upgrades.service

    print-finish "Customization finished!"
    if [[ -z "${module_selected}" ]]; then
        read -r -p "Reboot is required, do you want it now? (y/n) "
        [[ ${REPLY} == "y" || ${REPLY} == "Y" ]] && reboot
    fi
}

##################
## SCRIPT START ##
##################

# Strict mode
set -eufo pipefail
IFS=$'\n\t'

# Set default for PROJECT_ROOT
if ! printenv PROJECT_ROOT >/dev/null 2>&1; then
    path_self=$(realpath "${0}")
    PROJECT_ROOT=$(cd "$(dirname "$(dirname "${path_self}")")" >/dev/null 2>&1 && pwd)
    export PROJECT_ROOT
fi

source "${PROJECT_ROOT}/bin/bootstrap.sh"

# Parse options
cmd="${1:-}"
[[ -n "${cmd}" ]] && shift

# Show help if requested by option flag not help command
if [[ "${cmd}" != "help" ]]; then
    for arg in "${@}"; do
        if [[ "${arg}" == "--help" || "${arg}" == "-h" ]]; then
            "${PROJECT_ROOT}/bin/zephyrctl" help "${cmd}"
            exit 0
        fi
    done
fi

# Switch action
case "${cmd}" in
    remix|burn|partition|post-install|customize|install|uninstall) "_${cmd}" "${@}" ;;
    help) _usage "${1:-}" ;;
    *) _usage-main ;;
esac

exit 0
