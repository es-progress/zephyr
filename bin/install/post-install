#!/usr/bin/env bash
##################
## ES-Ubuntu    ##
##              ##
## Install      ##
## Post-install ##
## Steps runner ##
##################

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bootstrap.sh"
check-root || exit 1

read -rp "WARNING! Possible dangerous operation! Proceed? Type 'YES': "
[[ ${REPLY} != "YES" ]] && error-exit Aborted.

# Mount system
target=/target
# target="${PATH_EXTRACT}/squashfs-root"
for dir in proc sys dev etc/resolv.conf; do
    if ! findmnt "${target}/${dir}" >/dev/null; then
        mount --rbind "/${dir}" "${target}/${dir}"
    fi
done

print-status "Mount all file-systems..."
chroot "${target}" mount -a
print-finish

# Run Post-install steps
steps=$(find "${PATH_SCRIPTS_INSTALL}/post-install.d" -maxdepth 1 -type f -executable -printf "%P\n")
for step in ${steps}; do
    chroot "${target}" env PROJECT_ROOT="${GLOBAL_RES}" "${GLOBAL_RES}/bin/install/post-install.d/${step}" "${@}"
done

# Run local post-install steps
steps=$(find "${ES_CFG_LOCAL}/config/install/post-install.d" -maxdepth 1 -type f -executable -printf "%P\n")
for step in ${steps}; do
    chroot "${target}" env PROJECT_ROOT="${GLOBAL_RES}" "${GLOBAL_RES}/local/config/install/post-install.d/${step}" "${@}"
done

print-header "Update initramfs..."
chroot "${target}" update-initramfs -u -k all
print-finish

print-header "Update GRUB..."
chroot "${target}" update-grub
print-finish

print-finish "Post-install finished."

exit 0
