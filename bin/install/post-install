#!/usr/bin/env bash
##################
## Zephyr       ##
##              ##
## Install      ##
## Post-install ##
##################

# Strict mode
set -eufo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bin/bootstrap.sh"
check-root

profile="${1:?"Profile missing"}"
shift

read -rp "WARNING! This only meant to run after a clean Ubuntu install! Proceed? Type 'YES': "
[[ ${REPLY} != "YES" ]] && error-exit Aborted.

# Mount system
target=/target
# target="${PATH_EXTRACT}/squashfs-root"
for dir in proc sys dev etc/resolv.conf; do
    if ! findmnt "${target}/${dir}" >/dev/null; then
        mount --rbind "/${dir}" "${target}/${dir}"
    fi
done

print-status Mount all file-systems...
chroot "${target}" mount -a
print-finish

# Run Post-install steps
terminal=$(tty)
while IFS= read -r -d '' step; do
    print-header "Running step: ${step}..."
    chroot "${target}" env PROJECT_ROOT="${INSTALL_DIR}" "${INSTALL_DIR}/bin/install/post-install.d/${step}" "${profile}" "${@}" < "${terminal}"
    print-finish "Finished ${step}."
done < <(find "${PATH_SCRIPTS_INSTALL}/post-install.d" -maxdepth 1 -type f -executable -printf "%P\0" || true)

print-header Update initramfs...
chroot "${target}" update-initramfs -u -k all
print-finish

print-header Update GRUB...
chroot "${target}" update-grub
print-finish

print-finish "Post-install finished."

exit 0
