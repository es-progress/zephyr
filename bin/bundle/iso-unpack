#!/usr/bin/env bash
################
## ES-Ubuntu  ##
##            ##
## Packaging  ##
## Unpack ISO ##
################

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

iso_image="${1?:"ISO file missing"}"

if ! grep -qs "${ES_MOUNT}" /etc/mtab; then
    print-status "Mounting ISO..."
    mkdir -p "${ES_MOUNT}"
    sudo mount -o ro,loop "${iso_image}" "${ES_MOUNT}"
    print-finish
fi

print-header "Extract ISO contents..."
mkdir -p "${ES_EXTRACT}/iso"
sudo rsync \
    -aAXHEh \
    --info=stats1 --info=progress2 \
    --delete --inplace \
    "${ES_MOUNT}/" "${ES_EXTRACT}/iso"
print-finish

if grep -qs "${ES_MOUNT}" /etc/mtab; then
    print-status "Unmounting ISO..."
    sudo umount "${ES_MOUNT}"
    print-finish
fi

print-header "Extract SquashFS filesystem..."
if [[ ! -e "${ES_EXTRACT}/squashfs-root" ]]; then
    cd "${ES_EXTRACT}"
    sudo unsquashfs "${ES_EXTRACT}/iso/casper/filesystem.squashfs"
    print-finish
else
    print-finish "SquashFS already extracted"
fi

exit 0
