#!/usr/bin/env bash
################
## ES-Ubuntu  ##
##            ##
## Bundling   ##
## Unpack ISO ##
################

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

iso_image="${1?:"ISO file missing"}"

if ! findmnt "${ES_MOUNT}" >/dev/null; then
    print-status "Mounting ISO..."
    mkdir -p "${ES_MOUNT}"
    sudo mount -o ro,loop "${iso_image}" "${ES_MOUNT}"
    print-finish
fi

print-header "Extract ISO contents..."
mkdir -p "${ES_EXTRACT}/iso"
sudo rsync \
    -aAXHEh \
    --info=stats1 --info=progress2 \
    --delete --inplace \
    "${ES_MOUNT}/" "${ES_EXTRACT}/iso"
print-finish

if grep -qs "${ES_MOUNT}" /etc/mtab; then
    print-status "Unmounting ISO..."
    sudo umount "${ES_MOUNT}"
    print-finish
fi

if [[ -e "${ES_EXTRACT}/squashfs-root" ]]; then
    print-status "Clearing SquashFS extracting directory..."
    sudo rm -rf "${ES_EXTRACT}/squashfs-root"
    print-finish
fi

print-header "Extract SquashFS filesystem..."
sudo unsquashfs -dest "${ES_EXTRACT}/squashfs-root" "${ES_EXTRACT}/iso/casper/filesystem.squashfs"
print-finish

exit 0
