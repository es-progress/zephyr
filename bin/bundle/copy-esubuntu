#!/usr/bin/env bash
############################
## ES-Ubuntu              ##
##                        ##
## Bundling               ##
## Copy files to SquashFS ##
############################

# Strict mode
set -euo pipefail
IFS=$'\n\t'

source "${DIR_ESUBUNTU}/bootstrap.sh"
check-not-root || exit 1

print-status "Copy ES-Ubuntu to SquashFS..."
target="${ES_EXTRACT}/squashfs-root/${GLOBAL_RES}"
# Create dirs
sudo mkdir -p "${target}"
sudo mkdir -p "${target}/bin"
sudo mkdir -p "${target}/config"
# Main
sudo cp -r "${DIR_ESUBUNTU}/bootstrap.sh" "${target}/"
sudo cp -r "${DIR_ESUBUNTU}/ESubuntu.cfg" "${target}/"
sudo cp -r "${DIR_ESUBUNTU}/ESubuntu.path.cfg" "${target}/"
sudo cp -r "${DIR_ESUBUNTU}/esubuntuctl" "${target}/"
# Bin
sudo cp -r "${DIR_ESUBUNTU}/bin/library.sh" "${target}/bin/"
sudo cp -r "${DIR_ESUBUNTU}/bin/customize" "${target}/bin/"
sudo cp -r "${DIR_ESUBUNTU}/config/customize" "${target}/config/"
# Files
sudo cp -r "${DIR_ESUBUNTU}/files/" "${target}/"
# Local config
if [[ -e "${DIR_ESUBUNTU}/local/config" ]]; then
    sudo mkdir -p "${target}/local"
    sudo cp -r "${DIR_ESUBUNTU}/local/config" "${target}/local/"
fi
# Local files
if [[ -e "${DIR_ESUBUNTU}/local/files" ]]; then
    sudo mkdir -p "${target}/local"
    sudo cp -r "${DIR_ESUBUNTU}/local/files" "${target}/local/"
fi
# Symlink controller
sudo rm -f "${ES_EXTRACT}/squashfs-root/${GLOBAL_BIN}/esubuntuctl"
sudo ln -s "${GLOBAL_RES}/esubuntuctl" "${ES_EXTRACT}/squashfs-root/${GLOBAL_BIN}/esubuntuctl"
print-finish

print-status "Set permissions..."
sudo chmod -R u+rw,go+r "${target}"
sudo find "${target}" -executable -exec chmod go+x '{}' \;
print-finish

exit 0
