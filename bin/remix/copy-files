#!/usr/bin/env bash
############################
## ES-Ubuntu              ##
##                        ##
## Remix                  ##
## Copy files to SquashFS ##
############################

# Strict mode
set -eufo pipefail
IFS=$'\n\t'

source "${PROJECT_ROOT}/bootstrap.sh"
check-not-root || exit 1

print-status "Copy files to SquashFS..."
target="${PATH_EXTRACT}/squashfs-root/${INSTALL_DIR}"
sudo mkdir -p "${target}"
# General project files
sudo cp \
    "${PROJECT_ROOT}/bootstrap.sh" \
    "${PROJECT_ROOT}/ESubuntu.cfg" \
    "${PROJECT_ROOT}/esubuntuctl" \
    "${PROJECT_ROOT}/LICENSE" \
    "${PROJECT_ROOT}/README.md" "${target}/"
# Profiles
if [[ -e "${PROJECT_ROOT}/profiles" ]]; then
    sudo cp -Lr "${PROJECT_ROOT}/profiles" "${target}/"
fi
# Local config
if [[ -e "${PROJECT_ROOT}/ESubuntu.local.cfg" ]]; then
    sudo cp "${PROJECT_ROOT}/ESubuntu.local.cfg" "${target}/"
fi
# Symlink controller
sudo rm -f "${PATH_EXTRACT}/squashfs-root/usr/local/bin/esubuntuctl"
sudo ln -s "${INSTALL_DIR}/esubuntuctl" "${PATH_EXTRACT}/squashfs-root/usr/local/bin/esubuntuctl"
print-finish

print-status "Set permissions..."
sudo chmod -R u+rw,go+r "${target}"
sudo find "${target}" -executable -exec chmod go+x '{}' \;
print-finish

print-status "Patch GRUB..."
# Boot from encrypted partition
if ! grep -qs "GRUB_ENABLE_CRYPTODISK=y" "${PATH_EXTRACT}/squashfs-root/etc/default/grub"; then
    cat <<EOF | sudo tee -a "${PATH_EXTRACT}/squashfs-root/etc/default/grub" >/dev/null

# Enabling boot from LUKS
GRUB_ENABLE_CRYPTODISK=y
EOF
fi
print-finish

exit 0
