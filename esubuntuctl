#!/usr/bin/env bash
################
## ES-Ubuntu  ##
##            ##
## Controller ##
################

#############
# FUNCTIONS #
#############

# Usage
#######
usage(){
    local msg="${1:-}"
    [[ -n "${msg}" ]] && echo "${msg}"
    cat <<EOF

ES-Ubuntu controller

Usage:
esubuntuctl ACTION [OPTIONS...]

Commands:

create          Create ES-Ubuntu ISO

                esubuntuctl create ISO_FILE

                Command specific options:
                ISO_FILE                ISO to customize (ubuntu live-cd)

burn            Burn to ISO to USB

                esubuntuctl burn ISO_FILE [DISK]

                Command specific options:
                ISO_FILE                ISO to burn
                DISK                    Device to copy to (eg. /dev/sdc)

install         Install ES-Ubuntu

                esubuntuctl install [LOCAL_DIR]

                Command specific options:
                LOCAL_DIR               Absolute path to local config dir

update          Update a module

                esubuntuctl update MODULE

                Command specific options:
                MODULE                  Name of module to update (eg. packages, bash)
EOF
    exit 1
}

# Install
#########
install(){
    # Symlink local dir
    if [[ -n "${local_dir}" ]]; then
        [[ -h "${ES_CFG_LOCAL}" ]] && rm "${ES_CFG_LOCAL}"
        [[ ! -e "${ES_CFG_LOCAL}" ]] && ln -s "${local_dir}" "${ES_CFG_LOCAL}"
    fi

    "${ES_CUSTOMIZE_SCRIPTS}/runner"

    echo
    print-finish "Installation finished!"
    read -r -p "Reboot is required, do you want it now? (y/n) "
    [[ ${REPLY} == 'y' || ${REPLY} == 'Y' ]] && reboot
}

# Create ISO
############
create(){
    "${ES_BUNDLE_SCRIPTS}/iso-unpack" "${iso_image}"
    "${ES_BUNDLE_SCRIPTS}/copy-esubuntu"
    "${ES_BUNDLE_SCRIPTS}/iso-pack" "${iso_image}"
    "${ES_BUNDLE_SCRIPTS}/clean-up"
}

################
# SCRIPT START #
################

# Strict mode
set -euo pipefail
IFS=$'\n\t'

# Set default for DIR_ESUBUNTU
if ! printenv DIR_ESUBUNTU >/dev/null 2>&1; then
    path_self=$(realpath "${0}")
    DIR_ESUBUNTU="$(cd "$(dirname "${path_self}")" >/dev/null 2>&1 && pwd)"
    export DIR_ESUBUNTU
fi

source "${DIR_ESUBUNTU}/bootstrap.sh"

# Parse options
cmd="${1:-}"
[[ -z "${cmd}" ]] && usage "Command missing!"
shift
case "${cmd}" in
    create)
        iso_image="${1:-}"
        [[ -z "${iso_image}" ]] && usage "ISO image missing!"
        create
        ;;
    burn)
        iso_image="${1:-}"
        disk="${2:-}"
        [[ -z "${iso_image}" ]] && usage "ISO image missing!"
        "${ES_BUNDLE_SCRIPTS}/iso-burn" "${iso_image}" "${disk}"
        ;;
    install)
        local_dir="${1:-}"
        install
        ;;
    update)
        module="${1:-}"
        [[ -z "${module}" ]] && usage "Module missing!"
        "${ES_CUSTOMIZE_SCRIPTS}/runner" "${module}"
        ;;
    help|-h|--help)
        usage
        ;;
    *)
        usage "${cmd}: Unknown command!"
        ;;
esac

exit 0
